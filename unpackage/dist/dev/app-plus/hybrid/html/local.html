<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>网络网页</title>
    <style type="text/css">
        .btn {
            display: block;
            margin: 20px auto;
            padding: 5px;
            background-color: #007aff;
            border: 0;
            color: #ffffff;
            height: 40px;
            width: 200px;
        }

        .btn-red {
            background-color: #dd524d;
        }

        .btn-yellow {
            background-color: #f0ad4e;
        }

        .desc {
            padding: 10px;
            color: #999999;
        }

        .post-message-section {
            visibility: hidden;
        }
    </style>
</head>

<body>
    <p class="desc">web-view 组件加载网络 html 示例。点击下列按钮，跳转至其它页面。</p>
    <div class="btn-list">
        <button class="btn" type="button" data-action="navigateTo">navigateTo</button>
        <button class="btn" type="button" data-action="redirectTo">redirectTo</button>
        <button class="btn" type="button" data-action="navigateBack">navigateBack</button>
        <button class="btn" type="button" data-action="reLaunch">reLaunch</button>
        <button class="btn" type="button" data-action="switchTab">switchTab</button>
    </div>
    <div class="post-message-section">
        <p class="desc">网页向应用发送消息，注意：小程序端应用会在此页面后退时接收到消息。</p>
        <div class="btn-list">
            <button class="btn btn-red" type="button" id="postMessage">postMessage</button>
        </div>
    </div>
    <div class="bridge-demo">
        <p class="desc">Bridge 演示：H5 调用 App，并通过回调拿结果</p>
        <div class="btn-list">
            <button class="btn btn-yellow" type="button" id="btnShare">bridge: share()</button>
            <button class="btn btn-yellow" type="button" id="btnGetEnv">bridge: getEnv()</button>
        </div>
    </div>
    <script type="text/javascript">
        var userAgent = navigator.userAgent;
        if (userAgent.indexOf('AlipayClient') > -1) {
            // 支付宝小程序的 JS-SDK 防止 404 需要动态加载，如果不需要兼容支付宝小程序，则无需引用此 JS 文件。
            document.writeln('<script src="https://appx/web-view.min.js"' + '>' + '<' + '/' + 'script>');
        } else if (/QQ/i.test(userAgent) && /miniProgram/i.test(userAgent)) {
            // QQ 小程序
            document.write(
                '<script type="text/javascript" src="https://qqq.gtimg.cn/miniprogram/webview_jssdk/qqjssdk-1.0.0.js"><\/script>'
            );
        } else if (/miniProgram/i.test(userAgent) && /micromessenger/i.test(userAgent)) {
            // 微信小程序 JS-SDK 如果不需要兼容微信小程序，则无需引用此 JS 文件。
            document.write('<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"><\/script>');
        } else if (/toutiaomicroapp/i.test(userAgent)) {
            // 头条小程序 JS-SDK 如果不需要兼容头条小程序，则无需引用此 JS 文件。
            document.write(
                '<script type="text/javascript" src="https://lf1-cdn-tos.bytegoofy.com/goofy/developer/jssdk/jssdk-1.2.0.js"><\/script>');
        } else if (/swan/i.test(userAgent)) {
            // 百度小程序 JS-SDK 如果不需要兼容百度小程序，则无需引用此 JS 文件。
            document.write(
                '<script type="text/javascript" src="https://b.bdstatic.com/searchbox/icms/searchbox/js/swan-2.0.18.js"><\/script>'
            );
        } else if (/quickapp/i.test(userAgent)) {
            // quickapp
            document.write('<script type="text/javascript" src="https://quickapp/jssdk.webview.min.js"><\/script>');
        }
        if (!/toutiaomicroapp/i.test(userAgent)) {
            document.querySelector('.post-message-section').style.visibility = 'visible';
        }
    </script>
    <!-- uni 的 SDK 与桥接脚本 -->
    <script type="text/javascript" src="./js/uni.webview.1.5.6.js"></script>
    <script type="text/javascript" src="./js/wm-bridge.js"></script>
    <script type="text/javascript">
        (function () {
            // ===== Bridge 流程示意 =====
            // H5 -> App：wmappsdk.invoke(method, payload) 触发 uni.postMessage
            // App 接收：/pages/webview/index.vue 的 handlePostMessage -> dispatchBridgeCall
            // App 回调：this.bridge.respond(callId, value) -> H5 wmappsdk.appCallBackNew 收到，Promise resolve

            document.addEventListener('UniAppJSBridgeReady', function () {
                uni.getEnv(function (res) {
                    console.log('当前环境：' + JSON.stringify(res));
                });
                console.log('navigator.userAgent', navigator.userAgent);
            });

            // 示例：调用 App 侧 share 方法，并拿回结果
            function demoInvoke() {
                if (!window.wmappsdk) return;
                window.wmappsdk.invoke('share', { title: '标题', url: location.href }, { timeout: 6000 })
                    .then(function (resp) {
                        console.log('share resp:', resp);
                    })
                    .catch(function (err) {
                        console.log('share error:', err && err.message);
                    });
            }

            // 示例：页面加载后触发一次
            if (/wangmiaoApp/i.test(navigator.userAgent)) {
                demoInvoke();
            }

            // 绑定按钮（仍保留原按钮示例）
            document.querySelector('.btn-list').addEventListener('click', function (evt) {
                var target = evt.target;
                if (target.tagName === 'BUTTON') {
                    var action = target.getAttribute('data-action');
                    switch (action) {
                        case 'switchTab':
                            uni.switchTab({ url: '/pages/tabBar/API/API' });
                            break;
                        case 'reLaunch':
                            uni.reLaunch({ url: '/pages/tabBar/component/component' });
                            break;
                        case 'navigateBack':
                            uni.navigateBack({ delta: 1 });
                            break;
                        default:
                            uni[action]({ url: '/pages/component/button/button' });
                            break;
                    }
                }
            });

            // postMessage 示例
            var postBtn = document.getElementById('postMessage');
            if (postBtn) {
                postBtn.addEventListener('click', function () {
                    uni.postMessage({ data: { action: 'message' } });
                });
            }

            // ====== Bridge 演示按钮 ======
            var btnShare = document.getElementById('btnShare');
            if (btnShare) {
                btnShare.addEventListener('click', function () {
                    if (!window.wmappsdk) return;
                    window.wmappsdk.invoke('share', { title: 'H5 按钮发起分享', url: location.href })
                        .then(function (resp) { console.log('btn share resp:', resp); })
                        .catch(function (err) { console.log('btn share error:', err && err.message); });
                });
            }
            var btnGetEnv = document.getElementById('btnGetEnv');
            if (btnGetEnv) {
                btnGetEnv.addEventListener('click', function () {
                    if (!window.wmappsdk) return;
                    window.wmappsdk.invoke('getEnv', {})
                        .then(function (resp) { console.log('btn getEnv resp:', resp); })
                        .catch(function (err) { console.log('btn getEnv error:', err && err.message); });
                });
            }
        })();
    </script>
</body>

</html>